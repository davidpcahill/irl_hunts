<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a14">
    <meta name="description" content="IRL Hunts - Real-world predator vs prey game">
    <title>IRL Hunts - Play</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a14;
            color: #e0e0e0;
            min-height: 100vh;
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Prevent pull-to-refresh on mobile */
        html, body {
            overscroll-behavior-y: contain;
        }
        
        .header {
            background: linear-gradient(90deg, #1a1a2e, #16213e);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .header h1 {
            font-size: 1.3em;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-info {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .player-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .player-badge img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .connected { background: #00b894; }
        .disconnected { background: #d63031; animation: blink 1s infinite; }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .phase-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .phase-lobby { background: #636e72; }
        .phase-countdown { background: #fdcb6e; color: #000; animation: pulse 1s infinite; }
        .phase-running { background: #00b894; }
        .phase-paused { background: #e17055; }
        .phase-ended { background: #6c5ce7; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .mode-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: #feca57;
            color: #000;
        }
        
        .team-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: #48dbfb;
            color: #000;
        }
        
        .main {
            padding: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .mode-hint {
            background: linear-gradient(90deg, rgba(254,202,87,0.1), rgba(255,107,107,0.1));
            border: 1px solid rgba(254,202,87,0.3);
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
        
        .mode-hint strong { color: #feca57; }
        .mode-hint.infection { border-color: rgba(214,48,49,0.5); background: linear-gradient(90deg, rgba(214,48,49,0.1), rgba(225,112,85,0.1)); }
        .mode-hint.photo { border-color: rgba(9,132,227,0.5); background: linear-gradient(90deg, rgba(9,132,227,0.1), rgba(72,219,251,0.1)); }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .grid { grid-template-columns: 1fr 1fr; }
        }
        
        @media (min-width: 1200px) {
            .grid { grid-template-columns: 1fr 1fr 1fr; }
        }
        
        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            transition: transform 0.2s;
        }
        
        .card:hover { transform: translateY(-2px); }
        
        .card h2 {
            font-size: 1.1em;
            color: #888;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-card {
            background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(254,202,87,0.1));
            border-color: rgba(255,107,107,0.2);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .stat-label { color: #888; }
        .stat-value { font-weight: 700; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn:focus { outline: 2px solid #feca57; outline-offset: 2px; }
        
        /* Better focus for all interactive elements */
        button:focus, input:focus, select:focus { outline: 2px solid #feca57; outline-offset: 2px; }
        
        .btn-prey { background: #00cec9; color: #000; }
        .btn-pred { background: #ff7675; color: #fff; }
        .btn-success { background: #00b894; color: #fff; }
        .btn-warning { background: #fdcb6e; color: #000; }
        .btn-danger { background: #d63031; color: #fff; }
        .btn-primary { background: #0984e3; color: #fff; }
        
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .timer {
            font-size: 2.5em;
            font-weight: 700;
            text-align: center;
            color: #feca57;
            font-family: monospace;
            transition: color 0.3s;
        }
        
        .timer.warning {
            color: #e17055;
        }
        
        .timer.critical {
            color: #d63031;
            animation: timerFlash 1s infinite;
        }
        
        @keyframes timerFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .leaderboard { max-height: 350px; overflow-y: auto; }
        
        .lb-section h3 {
            color: #666;
            font-size: 0.85em;
            margin: 15px 0 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .lb-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .lb-rank { font-size: 1.4em; font-weight: 700; width: 35px; }
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        .lb-pic {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            background: #333;
        }
        
        .lb-info { flex: 1; }
        .lb-name { font-weight: 600; }
        .lb-stats { font-size: 0.85em; color: #888; }
        .lb-points { font-size: 1.2em; font-weight: 700; color: #feca57; }
        
        .online-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .online { background: #00b894; }
        .offline { background: #636e72; }
        .in-safe { background: #48dbfb; }
        
        .messages {
            height: 250px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .msg {
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        
        .msg-header { font-size: 0.8em; color: #666; margin-bottom: 4px; }
        .msg-from { color: #48dbfb; font-weight: 600; }
        .msg-content { color: #ccc; }
        
        .msg-form { display: flex; gap: 8px; }
        
        .msg-form input, .msg-form select {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .msg-form input { flex: 1; }
        
        .profile-section { text-align: center; }
        
        .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 3px solid rgba(255,255,255,0.2);
            background: #333;
        }
        
        .upload-label {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .upload-label:hover { background: rgba(255,255,255,0.2); }
        
        .sighting-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #0984e3;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(9,132,227,0.5);
            z-index: 1000;
        }
        
        .emergency-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #d63031;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(214,48,49,0.5);
            z-index: 1000;
        }
        
        .notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #00b894;
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            animation: slideIn 0.3s ease;
            z-index: 2000;
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.error, .notification.danger { background: #d63031; }
        .notification.warning { background: #e17055; }
        .notification.info { background: #0984e3; }
        .notification.success { background: #00b894; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h2 { margin-bottom: 20px; color: #fff; }
        
        .close-btn {
            float: right;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .gallery img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .captured-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(214,48,49,0.95);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }
        
        .captured-overlay.active { display: flex; }
        .captured-overlay h1 { font-size: 3em; margin-bottom: 20px; }
        .captured-overlay p { font-size: 1.3em; margin-bottom: 30px; }
        
        .emergency-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(214,48,49,0.98);
            z-index: 5000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
            animation: emergencyPulse 2s infinite;
        }
        
        .emergency-overlay.active { display: flex; }
        
        @keyframes emergencyPulse {
            0%, 100% { background: rgba(214,48,49,0.98); }
            50% { background: rgba(180,30,30,0.98); }
        }
        
        .emergency-overlay h1 { font-size: 2.5em; margin-bottom: 20px; animation: shake 0.5s infinite; }
        .emergency-overlay p { font-size: 1.2em; margin-bottom: 15px; }
        .emergency-overlay .emergency-details { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left; }
        .emergency-overlay .emergency-details p { margin-bottom: 10px; }
        .emergency-overlay strong { color: #feca57; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }
        
        .logout-btn {
            background: transparent;
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .logout-btn:hover { background: #ff6b6b; color: white; }
        
        input[type="file"] { display: none; }
        
        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }
        
        select {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .team-scores {
            background: rgba(72,219,251,0.1);
            border: 1px solid rgba(72,219,251,0.3);
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
        }
        
        .team-scores h3 { color: #48dbfb; margin-bottom: 10px; font-size: 14px; }
        
        .team-score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .team-score-name { font-weight: 600; }
        .team-score-value { color: #feca57; font-weight: 700; }
        
        .photo-requirement-warning {
            background: rgba(255,107,107,0.2);
            border: 1px solid #ff7675;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #ff7675;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a14; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s;">
        <div style="text-align: center;">
            <div style="font-size: 3em; margin-bottom: 20px;">üéØ</div>
            <div style="color: #feca57; font-size: 1.2em;">Loading IRL Hunts...</div>
        </div>
    </div>
    
    <div class="header">
        <h1>üéØ IRL HUNTS</h1>
        <div class="header-info">
            <div class="connection-status">
                <div id="connection-dot" class="connection-dot connected"></div>
                <span id="connection-text">Connected</span>
            </div>
            <div class="player-badge">
                <img id="header-pic" src="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2240%22>?</text></svg>'">
                <span id="header-name">{{ player.name }}</span>
            </div>
            <div id="mode-badge" class="mode-badge">CLASSIC</div>
            <div id="team-badge" class="team-badge" style="display: none;"></div>
            <div id="phase-badge" class="phase-badge phase-lobby">LOBBY</div>
            <button class="logout-btn" onclick="toggleSound()" id="sound-btn" title="Toggle notification sounds">üîä</button>
            <button class="logout-btn" onclick="logout()">Exit</button>
        </div>
    </div>
    
    <div class="main">
        <div id="mode-hint" class="mode-hint" style="display: none;"></div>
        
        <div class="grid">
            <!-- Profile & Status -->
            <div class="card status-card">
                <h2>üë§ Your Profile</h2>
                <div class="profile-section">
                    <img id="profile-pic" class="profile-pic" src="{{ player.profile_pic or '' }}" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2240%22>?</text></svg>'">
                    <br>
                    <input type="file" id="pic-upload" accept="image/*" onchange="uploadProfilePic(this)">
                    <label for="pic-upload" class="upload-label">üì∑ Change Photo</label>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">Nickname</span>
                    <span class="stat-value" id="your-name">{{ player.name }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Tracker ID</span>
                    <span class="stat-value">{{ player.device_id }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Role</span>
                    <span class="stat-value" id="your-role">{{ player.role|upper }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Status</span>
                    <span class="stat-value" id="your-status">{{ player.status|upper }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Points</span>
                    <span class="stat-value" id="your-points">{{ player.points }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Safe Zone</span>
                    <span class="stat-value" id="your-safezone">{{ 'YES' if player.in_safe_zone else 'NO' }}</span>
                </div>
                <div class="stat-row" id="team-row" style="display: none;">
                    <span class="stat-label">Team</span>
                    <span class="stat-value" id="your-team">-</span>
                </div>
                
                <div id="photo-requirement" class="photo-requirement-warning" style="display: none;">
                    üì∏ <strong>Photo Safari Mode:</strong> You must photograph prey before you can capture them!
                </div>
                
                <div id="photographed-prey" style="display: none; margin-top: 10px; padding: 10px; background: rgba(0,184,148,0.1); border: 1px solid rgba(0,184,148,0.3); border-radius: 8px; font-size: 12px;">
                    <strong style="color: #00b894;">üì∑ Can Capture:</strong>
                    <div id="photographed-list" style="margin-top: 5px; color: #ccc;">None yet</div>
                </div>
                
                <div style="margin-top: 15px;">
                    {% if player.role == 'unassigned' %}
                    <p style="color: #feca57; margin-bottom: 10px;">Choose your role:</p>
                    <div class="btn-group">
                        <button class="btn btn-prey" onclick="setRole('prey')">üê∞ Prey</button>
                        <button class="btn btn-pred" onclick="setRole('pred')">ü¶ä Predator</button>
                    </div>
                    {% else %}
                    <button class="btn btn-success" onclick="setReady()" id="ready-btn" style="width: 100%;">
                        ‚úÖ Ready to Play
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Game Timer -->
            <div class="card">
                <h2>‚è±Ô∏è Game Time</h2>
                <div id="timer" class="timer">--:--</div>
                <div id="live-stats" style="margin-top: 10px; font-size: 12px; color: #888;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Captures:</span><span id="stat-captures">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Escapes:</span><span id="stat-escapes">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Sightings:</span><span id="stat-sightings">0</span>
                    </div>
                </div>
                <p id="game-info" style="text-align: center; color: #888; margin-top: 10px;">
                    Waiting for game to start...
                </p>
                
                <div id="team-scores-section" class="team-scores" style="display: none;">
                    <h3>üèÜ Team Scores</h3>
                    <div id="team-scores-list"></div>
                </div>
                
                {% if is_mod %}
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="color: #888; font-size: 12px; margin-bottom: 10px;">MOD CONTROLS</p>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="startGame()">‚ñ∂Ô∏è</button>
                        <button class="btn btn-warning" onclick="pauseGame()">‚è∏Ô∏è</button>
                        <button class="btn btn-danger" onclick="endGame()">‚èπÔ∏è</button>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Leaderboard -->
            <div class="card">
                <h2>üèÜ Leaderboard</h2>
                <div class="leaderboard">
                    <div class="lb-section">
                        <h3>ü¶ä Predators</h3>
                        <div id="pred-lb"></div>
                    </div>
                    <div class="lb-section">
                        <h3>üê∞ Prey</h3>
                        <div id="prey-lb"></div>
                    </div>
                </div>
            </div>
            
            <!-- Messages -->
            <div class="card">
                <h2>üí¨ Chat</h2>
                <div id="messages" class="messages"></div>
                <div class="msg-form">
                    <select id="msg-to">
                        <option value="all">All</option>
                        <option value="team">Team</option>
                    </select>
                    <input type="text" id="msg-input" placeholder="Type message..." maxlength="500">
                    <button class="btn btn-primary" onclick="sendMsg()">Send</button>
                </div>
            </div>
            
            <!-- Photo Gallery -->
            <div class="card">
                <h2>üì∏ Sightings</h2>
                <div id="gallery" class="gallery">
                    <p style="color: #888; text-align: center; grid-column: 1/-1;">No photos yet</p>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="openSightingModal()">
                    üì∑ Upload Sighting (<span id="sighting-points">25</span> pts)
                </button>
            </div>
            
            <!-- Players Online -->
            <div class="card">
                <h2>üë• Players Online</h2>
                <div id="players-list" style="max-height: 250px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <!-- Floating Buttons -->
    <button class="sighting-btn" onclick="openSightingModal()" title="Photo Sighting">üì∑</button>
    <button class="emergency-btn" onclick="triggerEmergency()" title="Emergency - Use only for real emergencies!">üö®</button>
    
    <!-- Captured Overlay -->
    <div id="captured-overlay" class="captured-overlay">
        <h1>üö´ CAPTURED!</h1>
        <p id="captured-msg">You were caught!</p>
        <p id="captured-hint">Get to a SAFE ZONE beacon to escape!</p>
        <button class="btn btn-success" onclick="dismissCaptured()">I Understand</button>
    </div>
    
    <!-- Emergency Overlay -->
    <div id="emergency-overlay" class="emergency-overlay">
        <h1>üö® EMERGENCY üö®</h1>
        <p>GAME PAUSED - PLAYER NEEDS HELP!</p>
        <div class="emergency-details">
            <p><strong>Player:</strong> <span id="emergency-player-name">Unknown</span></p>
            <p><strong>Reason:</strong> <span id="emergency-reason">Emergency triggered</span></p>
            <p><strong>Location Hint:</strong> <span id="emergency-location">Unknown</span></p>
            <p><strong>Time:</strong> <span id="emergency-time">--:--:--</span></p>
        </div>
        <p style="font-size: 1.4em; color: #feca57;">HELP FIND THIS PLAYER!</p>
        <p style="font-size: 0.9em; color: #ccc;">Game will resume when moderator clears emergency</p>
    </div>
    
    <!-- Sighting Upload Modal -->
    <div id="sighting-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeSightingModal()">√ó</button>
            <h2>üì∑ Upload Sighting</h2>
            <p style="color: #888; margin-bottom: 15px;">
                Take a photo of another player to earn points!
            </p>
            
            <select id="sighting-target">
                <option value="">Select target player...</option>
            </select>
            
            <input type="file" id="sighting-photo" accept="image/*" capture="environment" onchange="previewSighting(this)">
            <label for="sighting-photo" class="btn btn-primary" style="display: block; text-align: center; margin: 10px 0;">
                üì∏ Take/Select Photo
            </label>
            
            <img id="sighting-preview" class="photo-preview">
            
            <button class="btn btn-success" style="width: 100%;" onclick="submitSighting()">
                Upload Sighting
            </button>
        </div>
    </div>
    

    <!-- Keyboard Shortcuts Help -->
    <div id="shortcuts-help" style="display: none; position: fixed; bottom: 150px; right: 20px; background: rgba(0,0,0,0.9); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); z-index: 100; font-size: 12px; max-width: 200px;">
        <div style="font-weight: 600; margin-bottom: 10px; color: #feca57;">‚å®Ô∏è Keyboard Shortcuts</div>
        <div style="color: #ccc; line-height: 1.8;">
            <div><kbd style="background: #333; padding: 2px 6px; border-radius: 3px;">P</kbd> Open photo sighting</div>
            <div><kbd style="background: #333; padding: 2px 6px; border-radius: 3px;">R</kbd> Refresh data</div>
            <div><kbd style="background: #333; padding: 2px 6px; border-radius: 3px;">Esc</kbd> Close modals</div>
            <div><kbd style="background: #333; padding: 2px 6px; border-radius: 3px;">?</kbd> Toggle this help</div>
        </div>
    </div>
    
    <script>
    const socket = io();
        const playerId = "{{ player.device_id }}";
        let playerData = {{ player|tojson }};
        let currentGameMode = "{{ game_mode }}";
        let modeConfig = {{ mode_config|tojson }};
        let emergencyActive = false;
        let capturedDismissed = false;
        
        // Connection status
        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('connection-dot').className = 'connection-dot connected';
            document.getElementById('connection-text').textContent = 'Connected';
        });
        
        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            document.getElementById('connection-dot').className = 'connection-dot disconnected';
            document.getElementById('connection-text').textContent = 'Disconnected';
            notify('Lost connection to server!', 'danger');
            
            // Show offline banner
            if (!document.getElementById('offline-banner')) {
                const banner = document.createElement('div');
                banner.id = 'offline-banner';
                banner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #d63031; color: white; padding: 10px; text-align: center; z-index: 9999; font-weight: bold;';
                banner.textContent = '‚ö†Ô∏è OFFLINE - Attempting to reconnect...';
                document.body.prepend(banner);
            }
        });
        
        socket.on('connect', () => {
            const banner = document.getElementById('offline-banner');
            if (banner) banner.remove();
        });
        
        socket.on('reconnect', () => {
            notify('Reconnected to server', 'success');
            // Reload everything after reconnect
            loadGameState();
            loadLeaderboard();
            loadPlayers();
            loadMessages();
            loadGallery();
        });
        
        // Game events - matching server emissions
        socket.on('event', (event) => {
            console.log('Event:', event);
            loadLeaderboard();
            loadPlayers();
        });
        
        socket.on('capture', (data) => {
            notify(`üéØ ${data.pred} captured ${data.prey}!`, 'warning');
            loadLeaderboard();
        });
        
        socket.on('infection', (data) => {
            notify(`ü¶† ${data.prey} has been INFECTED! Now a predator!`, 'danger');
            loadLeaderboard();
            loadPlayers();
        });
        
        socket.on('escape', (data) => {
            notify(`üèÉ ${data.prey} escaped!`, 'info');
            loadLeaderboard();
        });
        
        socket.on('sighting', (data) => {
            notify(`üì∏ ${data.spotter} spotted ${data.target}!`, 'info');
            loadGallery();
        });
        
        socket.on('notification', (data) => {
            notify(data.message, data.type || 'info');
        });
        
        socket.on('player_update', (player) => {
            if (player.device_id === playerId) {
                updateMyStatus(player);
                // Reset dismissed flag if status changed from captured
                if (lastKnownStatus === 'captured' && player.status !== 'captured') {
                    capturedDismissed = false;
                }
                lastKnownStatus = player.status;
            }
            loadPlayers();
            loadLeaderboard();
        });
        
        socket.on('game_starting', (data) => {
            notify(`Game starting in ${data.countdown} seconds!`, 'warning');
            updatePhase('countdown');
            if (data.mode) {
                currentGameMode = data.mode;
                updateModeDisplay();
            }
        });
        
        socket.on('game_started', (data) => {
            notify('üéÆ GAME STARTED!', 'success');
            updatePhase('running');
            if (data && data.mode) {
                currentGameMode = data.mode;
                updateModeDisplay();
            }
        });
        
        socket.on('game_paused', () => {
            notify('‚è∏Ô∏è Game paused', 'warning');
            updatePhase('paused');
        });
        
        socket.on('game_resumed', () => {
            notify('‚ñ∂Ô∏è Game resumed', 'success');
            updatePhase('running');
        });
        
        socket.on('game_ended', (data) => {
            notify('üèÅ Game ended!', 'info');
            updatePhase('ended');
            loadLeaderboard();
        });
        
        socket.on('game_reset', () => {
            notify('üîÑ Game reset to lobby', 'info');
            updatePhase('lobby');
            loadGameState();
        });
        
        socket.on('mode_change', (data) => {
            currentGameMode = data.mode;
            modeConfig = data.config;
            updateModeDisplay();
            notify(`Game mode changed to: ${data.config.name}`, 'info');
        });
        
        socket.on('message', (msg) => {
            addMessage(msg);
        });
        
        // Emergency events
        socket.on('emergency_alert', (data) => {
            emergencyActive = true;
            showEmergencyOverlay(data);
            notify('üö® EMERGENCY TRIGGERED! Game Paused!', 'danger');
        });
        
        socket.on('emergency_cleared', () => {
            emergencyActive = false;
            hideEmergencyOverlay();
            notify('‚úÖ Emergency cleared - game can resume', 'success');
        });
        
        let soundEnabled = localStorage.getItem('irlhunts_sound') !== 'false';
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('irlhunts_sound', soundEnabled);
            document.getElementById('sound-btn').textContent = soundEnabled ? 'üîä' : 'üîá';
            notify(soundEnabled ? 'Sound enabled' : 'Sound disabled', 'info');
        }
        
        function playNotificationSound(type) {
            if (!soundEnabled) return;
            // Use Web Audio API for simple beeps
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                // Different tones for different types
                if (type === 'danger') {
                    osc.frequency.value = 440;
                    gain.gain.value = 0.3;
                } else if (type === 'success') {
                    osc.frequency.value = 880;
                    gain.gain.value = 0.2;
                } else {
                    osc.frequency.value = 660;
                    gain.gain.value = 0.15;
                }
                
                osc.start();
                setTimeout(() => {
                    osc.stop();
                    ctx.close();
                }, 150);
            } catch (e) {
                // Audio not supported, ignore
            }
        }
        
        function notify(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
            
            // Play sound for important notifications
            if (type === 'danger' || type === 'warning' || type === 'success') {
                playNotificationSound(type);
            }
        }
        
        // Update sound button on load
        document.getElementById('sound-btn').textContent = soundEnabled ? 'üîä' : 'üîá';
        
        function updatePhase(phase) {
            const badge = document.getElementById('phase-badge');
            badge.className = `phase-badge phase-${phase}`;
            badge.textContent = phase.toUpperCase();
        }
        
        function updateModeDisplay() {
            const modeBadge = document.getElementById('mode-badge');
            const modeHint = document.getElementById('mode-hint');
            const sightingPts = document.getElementById('sighting-points');
            const photoReq = document.getElementById('photo-requirement');
            const capturedHint = document.getElementById('captured-hint');
            
            modeBadge.textContent = modeConfig.name.toUpperCase().replace(' MODE', '');
            sightingPts.textContent = modeConfig.sighting_points || 25;
            
            // Mode-specific hints
            if (modeConfig.infection) {
                modeHint.innerHTML = '<strong>‚ö†Ô∏è INFECTION MODE:</strong> If captured, you become a predator! No escaping - last survivor wins 1000 points!';
                modeHint.className = 'mode-hint infection';
                modeHint.style.display = 'block';
                capturedHint.textContent = 'You have been INFECTED! You are now a PREDATOR!';
            } else if (modeConfig.photo_required) {
                modeHint.innerHTML = '<strong>üì∏ PHOTO SAFARI:</strong> Predators must photograph prey BEFORE capturing! Double photo points!';
                modeHint.className = 'mode-hint photo';
                modeHint.style.display = 'block';
                if (playerData.role === 'pred') {
                    photoReq.style.display = 'block';
                }
            } else if (modeConfig.team_mode) {
                modeHint.innerHTML = '<strong>üèÜ TEAM COMPETITION:</strong> Work with your team to get the most captures!';
                modeHint.className = 'mode-hint';
                modeHint.style.display = 'block';
            } else {
                modeHint.style.display = 'none';
                photoReq.style.display = 'none';
            }
        }
        
        function showEmergencyOverlay(data) {
            document.getElementById('emergency-player-name').textContent = data.player_name || 'Unknown';
            document.getElementById('emergency-reason').textContent = data.reason || 'Emergency triggered';
            document.getElementById('emergency-location').textContent = data.location_hint || 'Unknown';
            document.getElementById('emergency-time').textContent = data.time || new Date().toLocaleTimeString();
            document.getElementById('emergency-overlay').classList.add('active');
        }
        
        function hideEmergencyOverlay() {
            document.getElementById('emergency-overlay').classList.remove('active');
        }
        
        function updateMyStatus(player) {
            playerData = player;
            document.getElementById('your-name').textContent = player.name;
            document.getElementById('your-role').textContent = player.role.toUpperCase();
            document.getElementById('your-status').textContent = player.status.toUpperCase();
            document.getElementById('your-points').textContent = player.points;
            document.getElementById('your-safezone').textContent = player.in_safe_zone ? 'YES' : 'NO';
            document.getElementById('header-name').textContent = player.name;
            
            if (player.profile_pic) {
                document.getElementById('profile-pic').src = player.profile_pic;
                document.getElementById('header-pic').src = player.profile_pic;
            }
            
            // Team display
            if (player.team) {
                document.getElementById('team-badge').textContent = player.team;
                document.getElementById('team-badge').style.display = 'inline-block';
                document.getElementById('team-row').style.display = 'flex';
                document.getElementById('your-team').textContent = player.team;
            } else {
                document.getElementById('team-badge').style.display = 'none';
                document.getElementById('team-row').style.display = 'none';
            }
            
            // Captured overlay - don't show in infection mode (instant conversion)
            if (player.status === 'captured' && !capturedDismissed) {
                if (!modeConfig.infection) {
                    document.getElementById('captured-overlay').classList.add('active');
                }
            } else {
                document.getElementById('captured-overlay').classList.remove('active');
            }
            
            // Photo requirement display
            if (modeConfig.photo_required && player.role === 'pred') {
                document.getElementById('photo-requirement').style.display = 'block';
            } else {
                document.getElementById('photo-requirement').style.display = 'none';
            }
        }
        
        function dismissCaptured() {
            document.getElementById('captured-overlay').classList.remove('active');
            capturedDismissed = true;
        }
        
        // Reset dismiss flag when status changes
        let lastKnownStatus = playerData.status;
        
        async function setRole(role) {
            const roleNames = { pred: 'Predator ü¶ä', prey: 'Prey üê∞' };
            if (!confirm(`Become a ${roleNames[role]}?\n\nThis determines your objective for the game!`)) {
                return;
            }
            
            try {
                const resp = await fetch('/api/player', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({role})
                });
                if (resp.ok) {
                    notify(`You are now a ${role}!`, 'success');
                    location.reload();
                } else {
                    const data = await resp.json();
                    notify(data.error || 'Failed to set role', 'error');
                }
            } catch (err) {
                notify('Connection error', 'error');
            }
        }
        
        async function setReady() {
            try {
                const resp = await fetch('/api/player', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status: 'ready'})
                });
                if (resp.ok) {
                    notify('You are ready!', 'success');
                    document.getElementById('ready-btn').textContent = '‚úÖ Ready!';
                    document.getElementById('ready-btn').disabled = true;
                }
            } catch (err) {
                notify('Failed to set ready status', 'error');
            }
        }
        
        async function uploadProfilePic(input) {
            if (!input.files[0]) return;
            
            const formData = new FormData();
            formData.append('file', input.files[0]);
            
            try {
                const resp = await fetch('/api/player/photo', {
                    method: 'POST',
                    body: formData
                });
                
                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('profile-pic').src = data.url;
                    document.getElementById('header-pic').src = data.url;
                    notify('Profile picture updated!', 'success');
                } else {
                    notify('Failed to upload', 'error');
                }
            } catch (err) {
                notify('Upload error', 'error');
            }
        }
        
        async function loadStats() {
            try {
                const resp = await fetch('/api/stats');
                const stats = await resp.json();
                document.getElementById('stat-captures').textContent = stats.total_captures || 0;
                document.getElementById('stat-escapes').textContent = stats.total_escapes || 0;
                document.getElementById('stat-sightings').textContent = stats.total_sightings || 0;
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }
        
        async function loadGameState() {
            try {
                const resp = await fetch('/api/game');
                const state = await resp.json();
                
                updatePhase(state.phase);
                
                if (state.mode && state.mode !== currentGameMode) {
                    currentGameMode = state.mode;
                    if (state.mode_config) {
                        modeConfig = state.mode_config;
                    }
                    updateModeDisplay();
                }
                
                // Emergency status
                if (state.emergency && !emergencyActive) {
                    emergencyActive = true;
                    // Fetch full emergency details
                    loadEmergencyStatus();
                } else if (!state.emergency && emergencyActive) {
                    emergencyActive = false;
                    hideEmergencyOverlay();
                }
                
                const timer = document.getElementById('timer');
                const info = document.getElementById('game-info');
                
                if (state.phase === 'running' && state.time_remaining > 0) {
                    const mins = Math.floor(state.time_remaining / 60);
                    const secs = state.time_remaining % 60;
                    timer.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                    
                    // Timer warning colors
                    if (state.time_remaining < 60) {
                        timer.className = 'timer critical';
                    } else if (state.time_remaining < 300) {
                        timer.className = 'timer warning';
                    } else {
                        timer.className = 'timer';
                    }
                    let infoText = `${state.online_count} online`;
                    if (modeConfig.infection && state.prey_count !== undefined) {
                        infoText += ` ‚Ä¢ ${state.prey_count} prey left`;
                    }
                    infoText += ` ‚Ä¢ ${state.mode_name || modeConfig.name}`;
                    info.textContent = infoText;
                } else if (state.phase === 'lobby') {
                    timer.textContent = '--:--';
                    info.textContent = `${state.ready_count}/${state.player_count} ready`;
                } else if (state.phase === 'ended') {
                    timer.textContent = '00:00';
                    info.textContent = 'Game ended!';
                } else if (state.phase === 'paused') {
                    info.textContent = state.emergency ? 'üö® EMERGENCY - GAME PAUSED' : 'Game paused';
                } else {
                    timer.textContent = '--:--';
                    info.textContent = state.phase;
                }
                
                // Team scores
                if (state.team_scores && Object.keys(state.team_scores).length > 0 && modeConfig.team_mode) {
                    const teamSection = document.getElementById('team-scores-section');
                    const teamList = document.getElementById('team-scores-list');
                    teamSection.style.display = 'block';
                    
                    let teamsHtml = '';
                    const sortedTeams = Object.entries(state.team_scores).sort((a, b) => b[1] - a[1]);
                    for (const [team, score] of sortedTeams) {
                        teamsHtml += `<div class="team-score-item"><span class="team-score-name">${team}</span><span class="team-score-value">${score} captures</span></div>`;
                    }
                    teamList.innerHTML = teamsHtml;
                } else {
                    document.getElementById('team-scores-section').style.display = 'none';
                }
                
            } catch (err) {
                console.error('Failed to load game state:', err);
            }
        }
        
        async function loadEmergencyStatus() {
            try {
                const resp = await fetch('/api/emergency/status');
                const data = await resp.json();
                if (data.emergency) {
                    showEmergencyOverlay({
                        player_name: data.by,
                        reason: data.reason,
                        location_hint: data.location_hint,
                        time: data.time
                    });
                }
            } catch (err) {
                console.error('Failed to load emergency status:', err);
            }
        }
        
        async function loadLeaderboard() {
            try {
                const resp = await fetch('/api/leaderboard');
                const lb = await resp.json();
                
                const predDiv = document.getElementById('pred-lb');
                const preyDiv = document.getElementById('prey-lb');
                
                predDiv.innerHTML = lb.preds.map((p, i) => `
                    <div class="lb-item">
                        <div class="lb-rank rank-${i+1}">#${i+1}</div>
                        <img class="lb-pic" src="${p.profile_pic || ''}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/></svg>'">
                        <div class="lb-info">
                            <div class="lb-name">
                                <span class="online-dot ${p.online ? (p.in_safe_zone ? 'in-safe' : 'online') : 'offline'}"></span>
                                ${escapeHtml(p.name)}
                                ${p.team ? `<span style="font-size:10px;color:#48dbfb;">[${p.team}]</span>` : ''}
                            </div>
                            <div class="lb-stats">${p.captures} captures${p.infections > 0 ? `, ${p.infections} infections` : ''}</div>
                        </div>
                        <div class="lb-points">${p.points}</div>
                    </div>
                `).join('') || '<p style="color:#666">No predators</p>';
                
                preyDiv.innerHTML = lb.prey.map((p, i) => `
                    <div class="lb-item">
                        <div class="lb-rank rank-${i+1}">#${i+1}</div>
                        <img class="lb-pic" src="${p.profile_pic || ''}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/></svg>'">
                        <div class="lb-info">
                            <div class="lb-name">
                                <span class="online-dot ${p.online ? (p.in_safe_zone ? 'in-safe' : 'online') : 'offline'}"></span>
                                ${escapeHtml(p.name)}
                            </div>
                            <div class="lb-stats">${p.escapes} escapes, ${p.times_captured} caught</div>
                        </div>
                        <div class="lb-points">${p.points}</div>
                    </div>
                `).join('') || '<p style="color:#666">No prey</p>';
                
            } catch (err) {
                console.error('Failed to load leaderboard:', err);
            }
        }
        
        async function loadPhotographedPrey() {
            if (!modeConfig.photo_required || playerData.role !== 'pred') {
                document.getElementById('photographed-prey').style.display = 'none';
                return;
            }
            
            try {
                const resp = await fetch('/api/player/photos');
                const photos = await resp.json();
                const container = document.getElementById('photographed-prey');
                const list = document.getElementById('photographed-list');
                
                if (photos.length > 0) {
                    container.style.display = 'block';
                    list.innerHTML = photos.map(p => `<span style="background: rgba(0,184,148,0.3); padding: 2px 8px; border-radius: 10px; margin: 2px; display: inline-block;">${escapeHtml(p.name)}</span>`).join(' ');
                } else {
                    container.style.display = 'block';
                    list.innerHTML = '<em>None yet - photograph prey first!</em>';
                }
            } catch (err) {
                console.error('Failed to load photographed prey:', err);
            }
        }
        
        async function loadPlayers() {
            try {
                const resp = await fetch('/api/players');
                const players = await resp.json();
                
                const list = document.getElementById('players-list');
                const targetSelect = document.getElementById('sighting-target');
                
                let html = '';
                let targetOptions = '<option value="">Select target...</option>';
                
                for (const [id, p] of Object.entries(players)) {
                    if (p.role === 'unassigned') continue;
                    
                    html += `
                        <div class="lb-item">
                            <img class="lb-pic" src="${p.profile_pic || ''}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/></svg>'">
                            <div class="lb-info">
                                <div class="lb-name">
                                    <span class="online-dot ${p.online ? (p.in_safe_zone ? 'in-safe' : 'online') : 'offline'}"></span>
                                    ${escapeHtml(p.name)}
                                    ${p.team ? `<span style="font-size:10px;color:#48dbfb;">[${p.team}]</span>` : ''}
                                </div>
                                <div class="lb-stats">${p.role} | ${p.status}${p.in_safe_zone ? ' | üè† Safe' : ''}</div>
                            </div>
                        </div>
                    `;
                    
                    // Add to sighting targets (opposite role)
                    if (playerData.role === 'pred' && p.role === 'prey') {
                        targetOptions += `<option value="${id}">${escapeHtml(p.name)} (${id})</option>`;
                    } else if (playerData.role === 'prey' && p.role === 'pred') {
                        targetOptions += `<option value="${id}">${escapeHtml(p.name)} (${id})</option>`;
                    }
                }
                
                list.innerHTML = html || '<p style="color:#666">No players</p>';
                targetSelect.innerHTML = targetOptions;
                
            } catch (err) {
                console.error('Failed to load players:', err);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function loadMessages() {
            try {
                const resp = await fetch('/api/messages');
                const msgs = await resp.json();
                const container = document.getElementById('messages');
                container.innerHTML = '';
                msgs.forEach(addMessage);
            } catch (err) {
                console.error('Failed to load messages:', err);
            }
        }
        
        function addMessage(msg) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `
                <div class="msg-header">
                    <span class="msg-from">${escapeHtml(msg.from_name)}</span> to ${msg.to} ‚Ä¢ ${msg.time_str}
                </div>
                <div class="msg-content">${escapeHtml(msg.message)}</div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const to = document.getElementById('msg-to').value;
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                await fetch('/api/messages', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({to, message})
                });
                input.value = '';
            } catch (err) {
                notify('Failed to send message', 'error');
            }
        }
        
        async function loadGallery() {
            try {
                const resp = await fetch('/api/sightings');
                const sightings = await resp.json();
                
                const gallery = document.getElementById('gallery');
                if (sightings.length === 0) {
                    gallery.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1/-1;">No photos yet</p>';
                } else {
                    gallery.innerHTML = sightings.slice(0, 20).map(s => `
                        <img src="${s.photo}" title="${escapeHtml(s.spotter)} spotted ${escapeHtml(s.target)}" onclick="window.open('${s.photo}')">
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load gallery:', err);
            }
        }
        
        function openSightingModal() {
            document.getElementById('sighting-modal').classList.add('active');
        }
        
        function closeSightingModal() {
            document.getElementById('sighting-modal').classList.remove('active');
            document.getElementById('sighting-preview').style.display = 'none';
        }
        
        function previewSighting(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('sighting-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        async function submitSighting() {
            const targetId = document.getElementById('sighting-target').value;
            const photoInput = document.getElementById('sighting-photo');
            
            if (!targetId) {
                notify('Select a target player', 'error');
                return;
            }
            
            if (!photoInput.files[0]) {
                notify('Take or select a photo', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('target_id', targetId);
            formData.append('photo', photoInput.files[0]);
            
            // Check file size before upload (16MB limit)
            if (photoInput.files[0].size > 16 * 1024 * 1024) {
                notify('Photo too large! Maximum size is 16MB.', 'error');
                return;
            }
            
            try {
                const resp = await fetch('/api/sighting', {
                    method: 'POST',
                    body: formData
                });
                
                if (resp.ok) {
                    const data = await resp.json();
                    notify(`Sighting recorded! +${data.points} points`, 'success');
                    closeSightingModal();
                    loadGallery();
                    loadPhotographedPrey();  // Refresh photo list
                    photoInput.value = '';
                } else if (resp.status === 413) {
                    notify('Photo too large! Maximum size is 16MB.', 'error');
                } else {
                    const data = await resp.json();
                    notify(data.error || 'Upload failed', 'error');
                }
            } catch (err) {
                notify('Failed to upload sighting', 'error');
            }
        }
        
        async function triggerEmergency() {
            if (!confirm('‚ö†Ô∏è TRIGGER EMERGENCY ALERT?\n\nThis will:\n- PAUSE the game for everyone\n- Alert ALL players to find you\n- Only use for REAL emergencies!\n\nContinue?')) {
                return;
            }
            
            const reason = prompt('Emergency reason (optional):');
            
            try {
                const resp = await fetch('/api/emergency', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        reason: reason || 'Player triggered emergency from dashboard'
                    })
                });
                
                if (resp.ok) {
                    notify('üö® EMERGENCY ALERT SENT! Help is coming!', 'danger');
                } else {
                    const data = await resp.json();
                    notify(data.error || 'Failed to trigger emergency', 'error');
                }
            } catch (err) {
                notify('Failed to send emergency alert', 'error');
            }
        }
        
        async function startGame() {
            const duration = prompt('Game duration (minutes):', modeConfig.duration || '30');
            if (duration) {
                try {
                    const resp = await fetch('/api/game/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({duration: parseInt(duration), countdown: 10})
                    });
                    if (!resp.ok) {
                        const data = await resp.json();
                        notify(data.error || 'Failed to start', 'error');
                    }
                } catch (err) {
                    notify('Failed to start game', 'error');
                }
            }
        }
        
        async function pauseGame() {
            await fetch('/api/game/pause', {method: 'POST'});
        }
        
        async function endGame() {
            if (confirm('End game now?')) {
                await fetch('/api/game/end', {method: 'POST'});
            }
        }
        
        async function logout() {
            await fetch('/api/logout', {method: 'POST'});
            window.location.href = '/';
        }
        
        // Heartbeat
        function sendHeartbeat() {
            socket.emit('heartbeat');
        }
        
        // Global error handler
        window.onerror = function(msg, url, line, col, error) {
            console.error('Global error:', msg, url, line);
            notify('An error occurred. Try refreshing.', 'error');
            return false;
        };
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });
        
        // Initial load
        loadGameState();
        loadLeaderboard();
        loadPlayers();
        loadMessages();
        loadGallery();
        updateModeDisplay();
        loadPhotographedPrey();
        
        // Hide loading overlay
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 500);
            }
        }, 500);
        
        // Periodic updates
        setInterval(loadGameState, 3000);
        setInterval(loadLeaderboard, 10000);
        setInterval(loadPlayers, 10000);
        setInterval(sendHeartbeat, 10000);
        setInterval(loadStats, 5000);
        setInterval(loadPhotographedPrey, 15000);  // Refresh photo safari list
        
        // Initial stats load
        loadStats();
        
        // Enter to send message
        document.getElementById('msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMsg();
        });
        
        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case 'p':
                case 'P':
                    openSightingModal();
                    break;
                case 'r':
                case 'R':
                    loadLeaderboard();
                    loadPlayers();
                    loadGameState();
                    notify('Refreshed data', 'info');
                    break;
                case 'Escape':
                    closeSightingModal();
                    dismissCaptured();
                    break;
                case '?':
                    const help = document.getElementById('shortcuts-help');
                    if (help) {
                        help.style.display = help.style.display === 'none' ? 'block' : 'none';
                    }
                    break;
            }
        });
    </script>
</body>
</html>
